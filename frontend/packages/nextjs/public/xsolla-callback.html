<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Xsolla Login Success</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      text-align: center;
      padding: 2rem;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .success {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .message {
      font-size: 1.2rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <div class="success">‚úì</div>
    <div class="message">–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!</div>
    <p style="font-size: 0.9rem; opacity: 0.7;">–û–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...</p>
  </div>

  <script>
    (function() {
      try {
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        console.log('‚úÖ Callback page loaded');
        console.log('Token:', token ? token.substring(0, 50) + '...' : 'none');
        console.log('Code:', code || 'none');
        console.log('Window opener:', window.opener ? 'exists' : 'null');

        if (token) {
          // Always store token in localStorage as fallback
          localStorage.setItem('xsolla_temp_token', token);
          console.log('üíæ Token saved to localStorage');
          
          // Try to send to opener window
          if (window.opener && !window.opener.closed) {
            console.log('üì§ Sending token to opener window...');
            try {
              window.opener.postMessage({
                type: 'xsolla-login-success',
                token: token
              }, '*'); // Use '*' for cross-origin
              console.log('‚úÖ Token sent via postMessage');
            } catch (e) {
              console.error('‚ùå Failed to send postMessage:', e);
            }

            // Try to close popup
            setTimeout(() => {
              console.log('üö™ Attempting to close popup...');
              try {
                window.close();
              } catch (e) {
                console.log('‚ö†Ô∏è Cannot close popup, redirecting instead...');
                window.location.href = '/';
              }
            }, 1000);
          } else {
            console.log('‚ö†Ô∏è No opener window, redirecting to home...');
            // Redirect to home page (will pick up token from localStorage)
            setTimeout(() => {
              window.location.href = '/';
            }, 1500);
          }
        } else if (code) {
          // Authorization code received
          localStorage.setItem('xsolla_temp_code', code);
          localStorage.setItem('xsolla_temp_state', state || '');
          
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({
              type: 'xsolla-code-received',
              code: code,
              state: state
            }, '*');

            setTimeout(() => {
              try {
                window.close();
              } catch (e) {
                window.location.href = '/';
              }
            }, 1000);
          } else {
            window.location.href = '/?code=' + code + '&state=' + state;
          }
        } else {
          console.error('‚ùå No token or code found in URL');
          console.log('URL:', window.location.href);
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        }
      } catch (error) {
        console.error('üí• Callback error:', error);
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      }
    })();
  </script>
</body>
</html>
